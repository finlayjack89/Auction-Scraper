---
# ═══════════════════════════════════════════════════════════════════════
# SETUP TASKS (CatalogSetupCrew — runs once)
# ═══════════════════════════════════════════════════════════════════════

input_validation_error_handling:
  description: |-
    Perform comprehensive validation of the auction URL before processing.
    Test URL accessibility, inspect site structure to identify auction catalogs vs. error pages.
    Detect common auction platforms (Christie's, Sotheby's, Heritage, etc.) and provide
    platform-specific guidance.

    **CRITICAL — PAGINATION DETECTION (this is essential for the next phase):**
    - Scrape the first page of {auction_url}
    - Find the TOTAL lot count (e.g. "245 lots", "Showing 1-60 of 510 lots")
    - Count how many lots appear on the first page (this is lots_per_page)
    - Look for pagination links/buttons: "Next", "Page 2", page numbers "1 2 3 4 5"
    - Identify the URL pattern for page 2: does it use ?page=2, ?offset=60, ?pageNo=2, /page/2, or something else?
    - Report the EXACT pagination URL pattern AND the page 2 URL
    - Calculate total_pages = ceil(total_lots / lots_per_page)

    Note — keyword filtering is handled automatically by the system after extraction; you do not need to validate keywords.
  expected_output: |-
    Structured validation report with these EXACT fields (the system parses them):
    - url_status: ACCESSIBLE or BLOCKED or ERROR
    - platform_detected: platform name
    - requires_login: true or false
    - estimated_lots: number (TOTAL lots across ALL pages)
    - lots_per_page: number (lots visible on page 1)
    - pagination_detected: true or false
    - pagination_url_pattern: the URL parameter pattern, e.g. "?page=N" or "?offset=N" or "/page/N"
    - page_2_url: the FULL URL for page 2 (e.g. "https://example.com/auction/123?page=2")
    - total_pages: number (calculated or observed)
    - validation_errors: []
    - recommendations: []
  agent: scout___auction_navigator_keyword_filter

discover_buyer_premium:
  description: |-
    **BUYER'S PREMIUM DISCOVERY** - Scrape the auction house website at {auction_url} to find the exact buyer's premium percentage and fee structure.

    **DISCOVERY STRATEGY:**
    1. **Navigate to Terms of Sale / Buyer's Premium page** on the auction house website
    2. **Look for links** labelled "Terms", "Conditions of Sale", "Buyer's Premium", "Charges", "Fees" from the auction page
    3. **Extract the buyer's premium percentage** — this is often tiered (e.g. 25% up to £500,000, then 20% above)
    4. **Determine if VAT is charged on the premium** (most UK auctions charge VAT on buyer's premium)
    5. **Identify any additional fees** (Artist Resale Rights / ARR, handling fees, etc.)

    **FALLBACK:** If the buyer's premium cannot be found on the website, default to 25% + VAT (20%) which is the most common UK rate.

    **OUTPUT MUST BE STRUCTURED** so downstream agents can use the exact rates in profit calculations.
  expected_output: 'Structured buyer premium report: {buyers_premium_rate: "25%",
    buyers_premium_tiered: true/false, tier_details: [{threshold: "£X", rate: "Y%"}],
    vat_on_premium: true/false, vat_rate: "20%", additional_fees: [], source_url: "URL
    where terms were found", discovery_method: "scraped/defaulted"}.'
  agent: scout___auction_navigator_keyword_filter
  context:
  - input_validation_error_handling

# ═══════════════════════════════════════════════════════════════════════
# PER-PAGE EXTRACTION TASK (PageExtractionCrew — runs once per page)
# ═══════════════════════════════════════════════════════════════════════

extract_single_page:
  description: |-
    **SINGLE PAGE EXTRACTION** — Scrape exactly ONE catalog page and output all lots found on it as a JSON array. Do NOT navigate to other pages. Do NOT filter lots.

    **PAGE TO SCRAPE:** {page_url}

    **INSTRUCTIONS:**
    1. Use FirecrawlScrapeWebsiteTool to scrape the page at {page_url}
    2. If Firecrawl returns incomplete content, fall back to ScrapeWebsiteTool
    3. Parse every lot visible on THIS page into a JSON object
    4. Output the lots as a JSON array — do NOT try to navigate to other pages

    **OUTPUT FORMAT — MANDATORY:**
    Output a JSON array inside a ```json code fence. Include ONLY the lots on THIS page.
    Each lot object MUST have these fields:
    - "lot_number": string (the lot number)
    - "title": string (the full lot title as listed)
    - "estimate_low": number or null (low estimate in GBP, no currency symbol)
    - "estimate_high": number or null (high estimate in GBP, no currency symbol)
    - "description": string (any additional description text, or empty string)

    **EXAMPLE OUTPUT:**
    ```json
    [
      {"lot_number": "1", "title": "A Cartier Santos wristwatch", "estimate_low": 800, "estimate_high": 1200, "description": "Steel case, blue dial, box and papers"},
      {"lot_number": "2", "title": "Victorian mahogany table", "estimate_low": 200, "estimate_high": 400, "description": ""}
    ]
    ```

    **CRITICAL RULES:**
    - Output ALL lots on THIS page — do NOT skip any, do NOT filter
    - Do NOT navigate to other pages — only scrape {page_url}
    - If you cannot parse estimates, use null
    - Always use a ```json code fence around the array
  expected_output: "A JSON array of all lots found on this single page, inside a ```json
    code fence. Each lot has: lot_number, title, estimate_low, estimate_high, description.
    After the JSON, state: LOTS ON THIS PAGE: [number]."
  agent: scout___auction_navigator_keyword_filter
